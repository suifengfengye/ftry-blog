---
title: 异步Action
date: 2018-12-30 01:48:02
tags: redux
---

使用js做前端开发，异步是我们经常会遇到的。最常见的场景，就是我们在调取后台数据的时候发送的异步请求。我们使用原生js来温习一下。

{% codeblock %}
const xhr = new XMLHttpRequest()

xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status <= 300 || xhr.status === 304) {
            console.log(xhr.responseText)
        } else {
            console.log(`Request was unsuccessful: ${xhr.responseText}`)
        }
    }
}

xhr.open('get', 'url', true)
xhr.send(null)

{% endcodeblock %}

在这一小段代码里面，我们先创建一个XMLHttpRequest对象，然后使用onreadystatechange属性的回调函数来监听状态变化。接着使用open()函数建立链接，最后使用send()函数发送数据到url对应的地址。这是一段异步代码，当send()函数执行之后，代码会继续往下执行，等到url对应地址的响应数据返回之后，才会执行onreadystatechange回调函数。

针对这个场景，有三个关键的时刻：发起请求、接收到响应（成功或者失败，也可能会超时）。在不考虑太多的情况下，我们只需要在接收到成功响应的情况下，把返回的数据通过dispatch()传递到redux的state中，这样就把数据保存了起来。所以代码看起来会是这样的：

{% codeblock %}
const xhr = new XMLHttpRequest()

xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status <= 300 || xhr.status === 304) {
            dispatch({
                type: 'INIT_TODOS',
                data: JSON.parse(xhr.responseText)
            })
        } else {
            console.log(`Request was unsuccessful: ${xhr.responseText}`)
        }
    }
}

xhr.open('get', '/getTodos', true)
xhr.send(null)

{% endcodeblock %}

我们的案例是以"待办事项"为例子，并没有后台接口与之对应，所以在继续往下学习之前，我们需要考虑如何通过接口来拿到数据。正常的项目开发中，会有后台的小伙伴给我们提供接口。现在我们没有后台的小伙伴那该怎么办？这个场景，就要考虑到mockjs了。

# 1、 mockjs

mockjs的{% link 官网 http://mockjs.com %}的介绍很简单——"生成随机数据，拦截Ajax请求"。但是这个中文介绍的前后顺序貌似有点问题，正常的顺序应该是"拦截Ajax请求，生产随机数据"。也就是说，使用mockjs可以拦截我们写的ajax请求，然后生成随机的数据返回给ajax。

在mockjs中，可以使用Mock.mock()这个方法来设置拦截哪个url，以及设置返回什么数据。

当然我们先要安装mockjs依赖包。
{% codeblock %}
> npm install -D mockjs
{% endcodeblock %}

接着添加如下代码：

{% codeblock %}
// mock.js
Mock.mock('/getTodos', {
    'list|1-5': [{
        'text': 'todo-item',
        'completed|1': true,
    }]
})
{% endcodeblock %}

上述代码，Mock.mock()方法会拦截"/getTodos"请求，然后返回一个object对象，object对象包含一个list属性，list数组包含5个元素，每个元素的text属性为“todo-item”，completed属性为随机的boolean值。

{% codeblock %}
{
    list: [
        {
            text: 'todo-item',
            completed: true,
        },
        // ...
    ]
}
{% endcodeblock %}

最后别忘了在入口文件(index.js)中引入mock.js

{% codeblock %}
// src/index.js
// ...
import './mock'
// ...
{% endcodeblock %}

# 2、再回到ajax上


# 3、加一个loading

# 4、redux-thunk

