---
title: 异步Action
date: 2018-12-30 01:48:02
tags: redux
---

使用js做前端开发，异步是我们经常会遇到的。最常见的场景，就是我们在调取后台数据的时候发送的异步请求。我们使用原生js来温习一下。

{% codeblock %}
const xhr = new XMLHttpRequest()

xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status <= 300 || xhr.status === 304) {
            console.log(xhr.responseText)
        } else {
            console.log(`Request was unsuccessful: ${xhr.responseText}`)
        }
    }
}

xhr.open('get', 'url', true)
xhr.send(null)

{% endcodeblock %}

在这一小段代码里面，我们先创建一个XMLHttpRequest对象，然后使用onreadystatechange属性的回调函数来监听状态变化。接着使用open()函数建立链接，最后使用send()函数发送数据到url对应的地址。这是一段异步代码，当send()函数执行之后，代码会继续往下执行，等到url对应地址的响应数据返回之后，才会执行onreadystatechange回调函数。

针对这个场景，有三个关键的时刻：发起请求、接收到响应（成功或者失败，也可能会超时）。在不考虑太多的情况下，我们只需要在接收到成功响应的情况下，把返回的数据通过dispatch()传递到redux的state中，这样就把数据保存了起来。所以代码看起来会是这样的：

{% codeblock %}
const xhr = new XMLHttpRequest()

xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status <= 300 || xhr.status === 304) {
            dispatch({
                type: 'INIT_TODOS',
                data: xhr.responseText
            })
        } else {
            console.log(`Request was unsuccessful: ${xhr.responseText}`)
        }
    }
}

xhr.open('get', 'url', true)
xhr.send(null)

{% endcodeblock %}

我们的案例是以"待办事项"为例子，并没有后台接口与之对应，所以在继续往下学习之前，需要考虑怎样建立一个后台程序并提供接口。